<%@taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>

<style type="text/css">
.attributeDiv {
	margin-bottom: 10px;
}

/*.readable {
	width: 400px;
	top: 260px;
	position: absolute;
	right: 100px;
	background-color: lightgoldenrodyellow;
}*/
.readable {
	position: absolute;
	width: 400px;
	top: -8px;
	right: 2px;
	background-color: lightgoldenrodyellow;
}
/* fieldset input{
	width:80px;
} */
</style>
<script type="text/javascript">
	$(function() {
		if (!$("#slipNumberInput").val()) {
			$("#slipNumberInput").val(
					"<spring:message code="label.autoGenerated" />");
		}
		$('#slipDateInput').datepicker({
			dateFormat : 'yy/mm/dd'
		}).datepicker("setDate", new Date());
		$("#purchaseDate").datepicker({
			dateFormat : 'yy/mm/dd'
		}).datepicker("setDate", new Date());
		$("#remarksInput").focus();

		$("#addItem")
				.click(
						function() {

							var rowCount = $('#global-table tbody tr').length;
							$
									.ajax({
										url : "${pageContext.request.contextPath}/addNewItemToIS/"
												+ rowCount,
										type : 'GET',
										dataType : 'html',
										success : function(data) {
											if (!data) {
												alert("Item Not Found");
												return;
											}
											$("tbody").find('tr:last').before(
													data);
										},
										error : function(data, status, er) {
											console.log(data);
											alert("error: " + data
													+ " status: " + status
													+ " er:" + er);
										}
									});
						});

		function calculateTotal()
		{
			var sum = 0;
			$('#global-table tbody td input.qty-in-bag').each(function() {
				sum += Number($(this).val());
			});
			$("#totalQtyInBag").val(sum);
			
			var sum = 0;
			$('#global-table tbody td input.qty-in-kg').each(function() {
				sum += Number($(this).val());
			});
			$("#totalQtyInKg").val(sum);
			
			var sum = 0;
			$('#global-table tbody td input.sub-total').each(function() {
				sum += Number($(this).val());
			});
			$("#totalPrice").val(sum);
			
			var tprice = Number($("#totalPrice").val())+Number($("#transportCost").val())+Number($("#labourCost").val());
			var cprice=tprice-Number($("#deposit").val());
			$("#challanTotal").val(cprice);			
		}
		
		$("#global-table tbody").on('keyup', "tr td input.unit-price",
				function(e) {
					var unitPrice = $(this).val();
					$tr = $(this).parent().parent();
					var qty = $tr.find("td input.qty-in-kg").val();
					var subTotal = unitPrice * qty;
					$tr.find("td input.sub-total").val(subTotal);
					/*$tr.next().find("td input.serialField").focus();*/
					
					calculateTotal();
					e.preventDefault();
					return false;
				});
			
		$("#global-table tbody").on('blur', "tr td input.qty-in-bag",
				function(e) {
					calculateTotal();
		});
		$("#global-table tbody").on('blur', "tr td input.qty-in-kg",
				function(e) {
			var qty = $(this).val();
			$tr = $(this).parent().parent();
			var unitPrice = $tr.find("td input.unit-price").val();
			var subTotal = unitPrice * qty;
			$tr.find("td input.sub-total").val(subTotal);
			calculateTotal();
		});
		$("#labourCost").keyup(function(){						
			var tprice = Number($("#totalPrice").val())+Number($(this).val())+Number($("#transportCost").val());
			var cprice=tprice-Number($("#deposit").val());
			$("#challanTotal").val(cprice);
		});
		
		$("#transportCost").keyup(function(){						
			var tprice = Number($("#totalPrice").val())+Number($(this).val())+Number($("#labourCost").val());
			var cprice=tprice-Number($("#deposit").val());
			$("#challanTotal").val(cprice);
		});
		
		$("#deposit").keyup(function(){						
			var tprice = Number($("#totalPrice").val())+Number($("#transportCost").val())+Number($("#labourCost").val());
			var cprice = tprice-Number($(this).val());			
			$("#challanTotal").val(cprice);
		});
		
	/* 	$('a#viewReport').click(function(){
			var slip_id = $("#slipId").val();
			$.ajax({
				url : "${pageContext.request.contextPath}/viewISReport/"+slip_id,						
				type : 'GET',
				dataType : 'html',
				success : function(data) {									
				},
				error : function(data, status, er) {
					console.log(data);
					alert("error: " + data
							+ " status: " + status
							+ " er:" + er);
					}
				});
			}); */
		
		$("#global-table tbody ").on("click", "tr td a.remove", function() {
			if (confirm("Are you sure to delete?")) {
				var index2remove = $(this).data("index");
				$("#slipItems" + index2remove + "\\.wrapper").hide();
				$("#slipItems" + index2remove + "\\.remove").val("1");
				$("#slipItems" + index2remove + "\\.quantityInBag").val("0");
				$("#slipItems" + index2remove + "\\.quantityInKg").val("0");
				$("#slipItems" + index2remove + "\\.unitPrice").val("0");
				$("#slipItems" + index2remove + "\\.subTotalPrice").val("0");
				calculateTotal();
			}
			return false;
		});
		$('#createSlip').click(function(e) {
			var code = e.keyCode || e.which;
			if (code == 13) {
				e.preventDefault();
				return false;
			}
			/* 	var rowCount = $('#global-table tbody tr').length;
				if (rowCount == 0) {
					alert("You need to add items to the slip...");
					return false;
				} else { */
			if (confirm("Are You Sure to Create ?")) {
				$("#slipForm").submit();
				return true;
			} else {
				return false;
			}
		});
	});
</script>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<h3>
	<spring:message code="label.incomingSlip" />
	<c:if test="${slip.id != null}">
			<input type="hidden" id="slipId" value="${slip.id}">
			<a style="float: right; text-decoration: none;" href="${contextPath}/viewISReport/${slip.id}" target="_blank"><spring:message code="label.printChallan"/></a> 			
		</c:if>
</h3>
<c:choose>
	<c:when test="${type eq 'create'}">
		<c:set var="actionUrl" value="${pageContext.request.contextPath}/incomingSlip/create" />
	</c:when>
	<c:otherwise>
		<c:set var="actionUrl"
			value="${pageContext.request.contextPath}/incomingSlip/update/${slip.id}" />
	</c:otherwise>
</c:choose>
<form:form cssStyle="position:relative" id="slipForm" action="${actionUrl}" modelAttribute="slip"
	enctype="multipart/form-data">
	<form:hidden path="id" />
	<form:hidden path="slipType" />
	<form:hidden path="createdBy" />
	<form:hidden path="creationDate" />
	<form:hidden path="slipStatus" />
	<form:errors path="*" cssClass="error" element="div" />
	<p>
		<label for="slipNumberInput"><spring:message
				code="label.slipNumber" /></label>
		<form:input path="slipNumber" id="slipNumberInput" readonly="true" />
	</p>
	<p>
		<label for="slipDateInput"><spring:message
				code="label.receivingDate" /></label>
		<form:input path="slipDate" id="slipDateInput" />
	</p>
	<p>
		<label for="remarksInput"><spring:message code="label.remarks" /></label>
		<form:textarea style="vertical-align: middle" rows="1" cols="40"
			path="remarks" id="remarksInput" />
	</p>
	<p>
		<label for="vendorInput"><spring:message code="label.vendor" /></label>
		<form:select path="vendor">
			<option value=""><spring:message code="label.selectOne" /></option>
			<c:forEach items="${vendorList}" var="vendor">
				<option
					<c:if test="${vendor.id eq slip.vendor.id}">selected="selected"</c:if>
					value="${vendor.id}">${vendor.name}</option>
			</c:forEach>
		</form:select>
	</p>
	<fieldset class="readable">
		
		<!-- <label for="totalQtyInBag"> --><spring:message code="label.totalQuantityInBag" /><!-- </label> -->
		<form:input cssStyle="width:77px" path="totalQtyInBag" id="totalQtyInBag" readonly="true" />
		<!-- <label for="totalQtyInKg"> --><spring:message code="label.totalQuantityInKg" /><!-- </label> -->
		<form:input cssStyle="width:77px" path="totalQtyInKg" id="totalQtyInKg" readonly="true"/>
		<hr>
		<label for="totalPrice"><spring:message code="label.totalPrice" /></label>
		<form:input path="totalPrice" id="totalPrice" readonly="true"/>
		<!-- <hr> -->
		<label for="labourCost"><spring:message code="label.labourCost" /></label>
		<form:input path="labourCost" id="labourCost" />
		<label for="transportCost"><spring:message code="label.transportCost" /></label>
		<form:input path="transportCost" id="transportCost"/>
		<!-- <hr> -->
		<label for="deposit"><spring:message code="label.deposit" /></label>
		<form:input path="deposit" id="deposit"/>
		<!-- <hr> -->
		<label for="slipTotalPrice"><spring:message code="label.slipTotalPrice" /></label>		
		<form:input path="challanPrice" id="challanTotal" readonly="true"/> 	
	</fieldset>
 
	<h3>
		<spring:message code="label.itemList" />
	</h3>
	<table id="global-table">
		<thead>
			<tr>
				<th><spring:message code="label.no" /></th>
				<th><spring:message code="label.item" /></th>
				<th><spring:message code="label.quantityInBag" /></th>
				<th><spring:message code="label.quantityInKg" /></th>
				<th><spring:message code="label.unitPrice" /></th>
				<th><spring:message code="label.subTotal" /></th>
				<th><spring:message code="label.action" /></th>
			</tr>
		</thead>
		<tbody>
			<c:forEach items="${slip.slipItems}" var="slipItem" varStatus="loop">
				<!-- Add a wrapping tr -->
				<c:choose>
					<c:when test="${slipItem.remove eq 1}">
						<tr id="slipItems${loop.index}.wrapper" class="hidden">
					</c:when>
					<c:otherwise>
						<tr id="slipItems${loop.index}.wrapper">
					</c:otherwise>
				</c:choose>
				<!-- Generate the fields -->
				<td><c:out value="${loop.count}"></c:out></td>
				<td><form:select path="slipItems[${loop.index}].itemType">
						<form:options items="${itemTypeList}" itemValue="id"
							itemLabel="name"></form:options>
					</form:select>
				<td><form:input class="qty-in-bag" path="slipItems[${loop.index}].quantityInBag"
						value="${slipItem.quantityInBag }" /></td>
				<td><form:input class="qty-in-kg" path="slipItems[${loop.index}].quantityInKg"
						value="${slipItem.quantityInKg }" /></td>
				<%-- <td><form:select path="slipItems[${loop.index}].unit">
						<form:options items="${nothing_required}"></form:options>
					</form:select></td> --%>
				<td><form:input class="unit-price" path="slipItems[${loop.index}].unitPrice"
						value="${slipItem.unitPrice }" /></td>
				<td><form:input class="sub-total" path="slipItems[${loop.index}].subTotalPrice"
						value="${slipItem.subTotalPrice }" /></td>
				<!-- Add a link to remove the SlipItem -->
				<td><a href="#" class="remove" data-index="${loop.index}">remove</a></td>
				<!-- Add the remove flag -->
				<c:choose>
					<c:when test="${slipItem.remove eq 1}">
						<c:set var="hiddenValue" value="1" />
					</c:when>
					<c:otherwise>
						<c:set var="hiddenValue" value="0" />
					</c:otherwise>
				</c:choose>
				<form:hidden path="slipItems[${loop.index}].remove"
					value="${hiddenValue}" />
				<form:hidden path="slipItems[${loop.index}].id" />
				</tr>
			</c:forEach>
			<tr>
				<td colspan="7"><a id="addItem" style="background-color: lightgrey" href=#><spring:message
							code="label.addNewItem" /></a></td>
			</tr>
		</tbody>
	</table>
	<br/>
	<p>
		<c:if test="${slip.slipStatus eq 'SAVED'}">
			<input type="button" id="createSlip"
				value="<spring:message code="label.saveSlip"/>" />
		</c:if>
	</p>
</form:form>
