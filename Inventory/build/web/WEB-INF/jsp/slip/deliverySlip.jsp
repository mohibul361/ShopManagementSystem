<%@taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>


<!-- <script src="http://code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css"> -->
<script src="<c:url value="/resources/scripts/popup.js" />"></script>
<style> 
.readable {
	position: absolute;
	width: 400px;
	top: -8px;
	right: 2px;
	background-color: lightgoldenrodyellow;
}
</style>
<script type="text/javascript">
	var customerSelected = false;
	var type = "${type}";
	
	$(function() {
		if (!$("#slipNumberInput").val()) {
			$("#slipNumberInput").val("<spring:message code="label.autoGenerated" />");
		}
		$('#slipDateInput').datepicker({
			dateFormat : 'yy/mm/dd'
		}).datepicker("setDate", new Date());

		$("#remarksInput").focus();

		$("#global-table tbody").on('blur', "tr td input.qty-in-bag", function(e) 
	    {
			$tr = $(this).parent().parent();
			var vendorId = $tr.find("td select.vendor option:selected").val();			
			var itemTypeId = $tr.find("td select.item-type option:selected").val();
			var qty = $tr.find("td input.qty-in-bag").val();
			$.ajax({
	        	headers : {
	                'Accept' : 'application/json',
	                'Content-Type' : 'application/json;charset=utf-8'
	            },
	            type: 'get',
	            url: '${contextPath}/checkItemStatus/'+vendorId+"/"+itemTypeId+"/"+qty+"/true",
	            dataType : 'json',	            
	            success : function(callback){
	            	console.log("callback: "+callback);
	            	if(!callback)
	            		{
	            			alert(qty+ " বস্তা চাল স্টক এ নাই !!!");
	            			$tr.find("td input.qty-in-bag").val("");
	            			$tr.find("td input.qty-in-bag").focus();
	            		}
	            },
	            error : function(){
	            	
	            }
		    });
			
		});
		$("#global-table tbody").on('blur', "tr td input.qty-in-kg", function(e) 
		{
			$tr = $(this).parent().parent();
			var vendorId = $tr.find("td select.vendor option:selected").val();			
			var itemTypeId = $tr.find("td select.item-type option:selected").val();
			var qty = $tr.find("td input.qty-in-kg").val();
			$.ajax({
	        	headers : {
	                'Accept' : 'application/json',
	                'Content-Type' : 'application/json'
	            },
	            type: 'get',
	            url: '${contextPath}/checkItemStatus/'+vendorId+"/"+itemTypeId+"/"+qty+"/false",
	            dataType : 'json',	            
	            success : function(callback){
	            	console.log("callback: "+callback);
	            	if(!callback)
	            		{
	            			alert(qty+ " কেজি চাল স্টক এ নাই !!!");
	            			$tr.find("td input.qty-in-kg").val("");
	            			$tr.find("td input.qty-in-kg").focus();
	            		}
	            },
	            error : function(){
	            	
	            }
		    });				
		});
		$("#global-table tbody").on('change', "tr td select.vendor", function(e) 
		{
			$tr = $(this).parent().parent();
			$tr.find("td input.qty-in-bag").val("");
			$tr.find("td input.qty-in-kg").val("");
			$tr.find("td input.unit-price").val("");
			$tr.find("td input.sub-total").val("");
			calculateTotal();
		});
		$("#global-table tbody").on('change', "tr td select.item-type", function(e) 
		{
			$tr = $(this).parent().parent();
			$tr.find("td input.qty-in-bag").val("");
			$tr.find("td input.qty-in-kg").val("");
			$tr.find("td input.unit-price").val("");
			$tr.find("td input.sub-total").val("");
			calculateTotal();
		});
		function  calculateTotal()
		{
			var sum = 0;
			$('#global-table tbody td input.qty-in-bag').each(function() {
				
				/* var value = $(this).text();
				if(!isNaN(value) && value.length != 0) {
			        sum += parseFloat(value);
			    } */
				sum += Number($(this).val());
			});
			$("#totalQtyInBag").val(sum);
			
			var sum = 0;
			$('#global-table tbody td input.qty-in-kg').each(function() {
				sum += Number($(this).val());
			});
			$("#totalQtyInKg").val(sum);
			
			var sum = 0;
			$('#global-table tbody td input.sub-total').each(function() {
				sum += Number($(this).val());
			});
			$("#totalPrice").val(sum);
			
			var tprice = Number($("#totalPrice").val())+Number($("#prevBalance").val())-Number($("#deposit").val());
			$("#challanTotal").val(tprice);
		}
		$("#global-table tbody").on('keyup', "tr td input.unit-price",
				function(e) {
					var unitPrice = $(this).val();
					$tr = $(this).parent().parent();
					var qty = $tr.find("td input.qty-in-kg").val();
					var subTotal = unitPrice * qty;
					$tr.find("td input.sub-total").val(subTotal);
					/*$tr.next().find("td input.serialField").focus();*/
					calculateTotal();
					e.preventDefault();
					return false;
				});
				
		$("#global-table tbody").on('blur', "tr td input.qty-in-bag",
				function(e) {
					calculateTotal();
		});
		$("#global-table tbody").on('blur', "tr td input.qty-in-kg",
				function(e) {
			var qty = $(this).val();
			$tr = $(this).parent().parent();
			var unitPrice = $tr.find("td input.unit-price").val();
			var subTotal = unitPrice * qty;
			$tr.find("td input.sub-total").val(subTotal);
			calculateTotal();
		});
		$("#prevBalance").keyup(function(){						
			var tprice = Number($("#totalPrice").val())+Number($(this).val());
			var cprice = tprice-Number($("#deposit").val());
			$("#challanTotal").val(cprice);
		});	
				
		$("#deposit").keyup(function(){						
			/* var tprice = Number($("#totalPrice").val())+Number($("#labourCost").val()); */
			var tprice = Number($("#totalPrice").val())+Number($("#prevBalance").val());
			var cprice = tprice-Number($(this).val());			
			$("#challanTotal").val(cprice);
		});
		
		$('#createSlip').click(function(e) {
			var code = e.keyCode || e.which;
			if (code == 13) {
				e.preventDefault();
				return false;
			}
			if (confirm("Are You Sure to Create ?")) {
				$("#slipForm").submit();
				return true;
			} else {
				return false;
			}
		});
		$("#global-table tbody ").on("click", "tr td a.remove", function() {
			if (confirm("Are you sure to delete?")) {
				var index2remove = $(this).data("index");
				$("#slipItems" + index2remove + "\\.wrapper").hide();
				$("#slipItems" + index2remove + "\\.remove").val("1");
				$("#slipItems" + index2remove + "\\.quantityInBag").val("0");
				$("#slipItems" + index2remove + "\\.quantityInKg").val("0");
				$("#slipItems" + index2remove + "\\.unitPrice").val("0");
				$("#slipItems" + index2remove + "\\.subTotalPrice").val("0");
				calculateTotal();				
			}
			return false;
		});
		
		$("#addItem")
				.click(
						function() {

							var rowCount = $('#global-table tbody tr').length;
							$.ajax({
										url : "${pageContext.request.contextPath}/addNewItemToDS/"
												+ rowCount,
										type : 'GET',
										dataType : 'html',
										success : function(data) {
											if (!data) {
												alert("Item Not Found");
												return;
											}
											$("tbody").find('tr:last').before(
													data);
										},
										error : function(data, status, er) {
											console.log(data);
											alert("error: " + data
													+ " status: " + status
													+ " er:" + er);
										}
									});
						});		
		   $('#customerName').on('change',function(e){
					var id = $('#deliveredTo').val();
					if (!id) {
						$("#prevBalance").val("0.0");
						return;
					}

					reqUrl = "${pageContext.request.contextPath}/customerBalance/"
							+ id;

					$.ajax({
						url : reqUrl,
						type : 'GET',
						dataType : 'html',
						success : function(data) {
							$("#prevBalance").val(data);
							var tprice = Number($("#totalPrice").val())+Number($("#prevBalance").val())-Number($("#deposit").val());
							$("#challanTotal").val(tprice);
						},
						error : function(data, status, er) {
							console.log(data);
							alert("error: " + data + " status: "
									+ status + " er:" + er);
						}
					});
			
		    });
		/* $("#deliveredTo")
		.change(
				function() {
					var id = $('option:selected', this).val();
					if (!id) {
						$("#prevBalance").val("0.0");
						return;
					}

					reqUrl = "${pageContext.request.contextPath}/customerBalance/"
							+ id;

					$.ajax({
						url : reqUrl,
						type : 'GET',
						dataType : 'html',
						success : function(data) {
							$("#prevBalance").val(data);
							var tprice = Number($("#totalPrice").val())+Number($("#prevBalance").val())-Number($("#deposit").val());
							$("#challanTotal").val(tprice);
						},
						error : function(data, status, er) {
							console.log(data);
							alert("error: " + data + " status: "
									+ status + " er:" + er);
						}
					});
				}); */
	});
	
</script>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<h3>
	<spring:message code="label.deliverySlip"/>
	<c:if test="${slip.id != null}">
			<input type="hidden" id="slipId" value="${slip.id}">
			<a style="float: right; text-decoration: none;" href="${contextPath}/viewDSReport/${slip.id}" target="_blank"><spring:message code="label.printChallan"/></a>					
		</c:if>
</h3>
<c:choose>
	<c:when test="${type eq 'create'}">
		<c:set var="actionUrl" value="${contextPath}/deliverySlip/create" />
	</c:when>
	<c:otherwise>
		<c:set var="actionUrl"
			value="${contextPath}/deliverySlip/update/${slip.id}" />
	</c:otherwise>
</c:choose>

<form:form cssStyle="position:relative" id="slipForm" action="${actionUrl}" modelAttribute="slip"
	enctype="multipart/form-data">
	<form:hidden path="id" />
	<form:hidden path="slipType" />
	<form:hidden path="createdBy" />
	<form:hidden path="creationDate" />
	<form:hidden path="slipStatus" />
	<form:errors path="*" cssClass="error" element="div" />
	<fieldset class="readable">
		<%-- <p><a id="viewReport" href="${contextPath}/viewReport/${slip.id}">View challan</a></p> --%>
				
		<label for="totalQtyInBag"><spring:message code="label.totalQuantityInBag" /></label>
		<form:input path="totalQtyInBag" id="totalQtyInBag" readonly="true" />
		<label for="totalQtyInKg"><spring:message code="label.totalQuantityInKg" /></label>
		<form:input path="totalQtyInKg" id="totalQtyInKg" readonly="true"/>
		<hr>
		<label for="totalPrice"><spring:message code="label.totalPrice" /></label>
		<form:input path="totalPrice" id="totalPrice" readonly="true"/>
		<label for="prevBalance"><spring:message code="label.prevBalance" /></label>
		<form:input path="prevBalance" id="prevBalance" readonly="true"/>
		<%-- <label for="labourCost"><spring:message code="label.labourCost" /></label>
		<form:input path="labourCost" id="labourCost" /> --%>
		<label for="deposit"><spring:message code="label.deposit" /></label>
		<form:input path="deposit" id="deposit"/>
		<label for="slipTotalPrice"><spring:message code="label.slipTotalPrice" /></label>
		<form:input path="challanPrice" id="challanTotal" readonly="true"/>		
	</fieldset>
	<p>
		<label for="slipNumberInput"><spring:message code="label.slipNumber"/></label>
		<form:input path="slipNumber" id="slipNumberInput" readonly="true" />
	</p>
	<p>
		<label for="slipDateInput"><spring:message code="label.deliveryDate"/></label>
		<form:input path="slipDate" id="slipDateInput" />
	</p>
	<p>
		<label for="remarksInput"><spring:message code="label.remarks"/></label>
		<form:textarea style="vertical-align: middle" rows="1" cols="40"
			path="remarks" id="remarksInput" />
	</p>
<%-- 	<p>
		<label for="recipientInput"><spring:message code="label.recipient" /></label>
		<form:select path="deliveredTo">
			<option value=""><spring:message code="label.selectOne" /></option>
			<c:forEach items="${recipientList}" var="recipient">
				<option
					<c:if test="${recipient.id eq slip.deliveredTo.id}">selected="selected"</c:if>
					value="${recipient.id}">${recipient.name}</option>
			</c:forEach>
		</form:select>
	</p>
 --%>	
 	<p>
		<form:hidden path="deliveredTo" />
		<label for="recipientInput"><spring:message code="label.recipient" /></label>
		<input type="text" id="customerName" value="${slip.deliveredTo.name}" >
		<a href="${contextPath}/recipientList" onClick="return PopupCenter(this, '', 800, 800)"><img style="height: 25px; vertical-align: middle" src="<c:url value="/resources/images/search.png" />"></a>
	</p>
		
	<div style="clear: both;"></div>
	
	<h3><spring:message code="label.itemList"/></h3>
        <table id="global-table" style="table-layout: fixed">
		<thead>
			<tr>
				<th style="width: 5%"><spring:message code="label.no"/></th>
				<th style="width: 20%"><spring:message code="label.vendor"/></th>
				<th style="width: 20%"><spring:message code="label.item"/></th>
				<th style="width: 10%"><spring:message code="label.quantityInBag" /></th>
				<th style="width: 10%"><spring:message code="label.quantityInKg" /></th>
				<th style="width: 10%"><spring:message code="label.unitPrice"/></th>
				<th style="width: 10%"><spring:message code="label.subTotal"/></th>
				<th style="width: 5%"><spring:message code="label.action"/></th>
			</tr>
		</thead>
		<tbody>
			<c:forEach items="${slip.slipItems}" var="slipItem" varStatus="loop">
				<!-- Add a wrapping tr -->
				<c:choose>
					<c:when test="${slipItem.remove eq 1}">
						<tr id="slipItems${loop.index}.wrapper" class="hidden">
					</c:when>
					<c:otherwise>
						<tr id="slipItems${loop.index}.wrapper">
					</c:otherwise>
				</c:choose>
				<!-- Generate the fields -->
				<td><c:out value="${loop.count}"></c:out></td>
				<td>
					<form:select path="slipItems[${loop.index}].vendor">						
						<form:options items="${vendorList}" itemValue="id" itemLabel="name"></form:options>
					</form:select>
				</td>
				<td>
					<form:select path="slipItems[${loop.index}].itemType">						
						<form:options items="${itemTypeList}" itemValue="id" itemLabel="name"></form:options>
					</form:select>
				</td>
				<td><form:input cssStyle="width:100px" class="qty-in-bag" path="slipItems[${loop.index}].quantityInBag"
						value="${slipItem.quantityInBag }" /></td>
				<td><form:input cssStyle="width:100px" class="qty-in-kg" path="slipItems[${loop.index}].quantityInKg"
						value="${slipItem.quantityInKg }" /></td>
				
				<td><form:input cssStyle="width:100px" class="unit-price" path="slipItems[${loop.index}].unitPrice" value="${slipItem.unitPrice }"/></td>
				<td><form:input cssStyle="width:100px" class="sub-total" path="slipItems[${loop.index}].subTotalPrice" value="${slipItem.subTotalPrice }"/></td>	
				<!-- Add a link to remove the SlipItem -->
				<td><a href="#" class="remove" data-index="${loop.index}">remove</a></td>				
				<!-- Add the remove flag -->
				<c:choose>
					<c:when test="${slipItem.remove eq 1}">
						<c:set var="hiddenValue" value="1" />
					</c:when>
					<c:otherwise>
						<c:set var="hiddenValue" value="0" />
					</c:otherwise>
				</c:choose>
				<form:hidden path="slipItems[${loop.index}].remove"
					value="${hiddenValue}" />
				<form:hidden path="slipItems[${loop.index}].id" />
				</tr>
			</c:forEach>
			<tr>
				<td colspan="8"><a id="addItem" href=#><spring:message code="label.addNewItem"/></a></td>
			</tr>
		</tbody>
	</table>
	<br/>
	<p>
		<c:if test="${slip.slipStatus eq 'SAVED'}">
			<input type="button" id="createSlip" value="<spring:message code="label.saveSlip"/>"/>
		</c:if>		
	</p>
</form:form>
